<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.utm.bd.mappers.FacturaMapper">
  <resultMap id="BaseResultMap" type="edu.utm.bd.domain.Factura">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 25 18:29:14 CDT 2018.
    -->
    <id column="id_factura" jdbcType="INTEGER" property="idFactura" />
    <result column="id_cliente" jdbcType="INTEGER" property="idCliente" />
    <result column="id_vendedor" jdbcType="INTEGER" property="idVendedor" />
    <result column="fecha" jdbcType="DATE" property="fecha" />
    <result column="monto_total" jdbcType="DECIMAL" property="montoTotal" />
  </resultMap>
  
   <resultMap id="FacturaCliente" type="edu.utm.bd.domain.Factura">
    <id column="id_factura" jdbcType="INTEGER" property="idFactura" />
    <result column="id_producto" jdbcType="INTEGER" property="idProducto" />
    <result column="fecha" jdbcType="INTEGER" property="fecha" />
    <result column="monto_total" jdbcType="DECIMAL" property="montoTotal" />
	
	<result column="ClienteNombre" jdbcType="VARCHAR" property="Client" />
    <result column="correo" jdbcType="VARCHAR" property="clienteDatos.correo" />
    
    <result column="VendedorNombre" jdbcType="VARCHAR" property="Vendedo" />
    
    
    <result column="nombre" jdbcType="VARCHAR" property="productoDatos.nombre" />
    <result column="precio" jdbcType="VARCHAR" property="productoDatos.precio" />
     <result column="precio_compra" jdbcType="VARCHAR" property="productoDatos.precioCompra" />
    
    <result column="cantidad" jdbcType="VARCHAR" property="detalleDatos.cantidad" />
    <result column="monto" jdbcType="VARCHAR" property="detalleDatos.monto" />
  </resultMap>
  
  <resultMap id="FacturaNombre" type="edu.utm.bd.domain.Factura">
    <id column="id_factura" jdbcType="INTEGER" property="idFactura" />
    <result column="id_producto" jdbcType="INTEGER" property="idProducto" />
    <result column="fecha" jdbcType="INTEGER" property="fecha" />
    <result column="monto_total" jdbcType="DECIMAL" property="montoTotal" />
	
	<result column="ClienteNombre" jdbcType="VARCHAR" property="Client" />
    <result column="VendedorNombre" jdbcType="VARCHAR" property="Vendedo" />
  </resultMap>
  
   <select id="findClienteByIdFactura" resultMap="FacturaCliente" parameterType="INTEGER">
  	SELECT concat(cliente.nombre," ",cliente.apellido) AS ClienteNombre, cliente.correo, 
  	concat(vendedor.nombre," ",vendedor.apellido) AS VendedorNombre,
 	producto.nombre, producto.precio, detalle.cantidad,
 	factura.monto_total, factura.fecha
  	FROM factura
  	JOIN cliente  ON factura.id_cliente  = cliente.id_cliente
  	JOIN vendedor ON factura.id_vendedor = vendedor.id_vendedor
  	JOIN detalle  ON factura.id_factura  = detalle.id_factura
  	JOIN producto ON detalle.id_producto = producto.id_producto
  	WHERE factura.id_factura = #{idFactura};
  	
  	<!-- SELECT concat(cliente.nombre," ",cliente.apellido)AS Cliente, cliente.correo,
  	concat(vendedor.nombre, " ",vendedor.apellido) AS Vendedor, factura.monto_total,
  	factura.fecha
  	FROM factura
  	JOIN cliente  ON factura.id_cliente  = cliente.id_cliente
  	JOIN vendedor ON factura.id_vendedor = vendedor.id_vendedor
  	WHERE factura.id_factura =  #{idFactura};-->
  </select>
  
     <select id="findProductosByIdFactura" resultMap="FacturaCliente" parameterType="INTEGER">
  		SELECT concat(cliente.nombre," ",cliente.apellido) AS ClienteNombre, cliente.correo, 
  	concat(vendedor.nombre," ",vendedor.apellido) AS VendedorNombre,
 	producto.nombre, producto.precio, detalle.cantidad,
 	factura.monto_total, factura.fecha
  	FROM factura
  	JOIN cliente  ON factura.id_cliente  = cliente.id_cliente
  	JOIN vendedor ON factura.id_vendedor = vendedor.id_vendedor
  	JOIN detalle  ON factura.id_factura  = detalle.id_factura
  	JOIN producto ON detalle.id_producto = producto.id_producto
  	WHERE factura.id_factura = #{idFactura};
  </select>
  
   <select id="findFacturaDay" resultMap="FacturaCliente" parameterType="STRING">
  	SELECT concat(cliente.nombre," ",cliente.apellido) AS ClienteNombre,
  	concat(vendedor.nombre," ",vendedor.apellido) AS VendedorNombre,
 	producto.nombre, producto.precio, producto.precio_compra, detalle.cantidad,
 	detalle.monto, factura.fecha
  	FROM factura
  	JOIN cliente  ON factura.id_cliente  = cliente.id_cliente
  	JOIN vendedor ON factura.id_vendedor = vendedor.id_vendedor
  	JOIN detalle  ON factura.id_factura  = detalle.id_factura
  	JOIN producto ON detalle.id_producto = producto.id_producto
  	WHERE factura.fecha = #{fecha};

  </select>
  
    <select id="findFacturaByNombre" resultMap="FacturaNombre" parameterType="STRING">
	SELECT concat(c.nombre," ",c.apellido) AS ClienteNombre, 
	concat(v.nombre," ",v.apellido) AS VendedorNombre, f.fecha, f.monto_total, f.id_factura
	FROM factura f
	JOIN cliente c 
	ON f.id_cliente  = c.id_cliente
	JOIN vendedor v
	ON f.id_vendedor = v.id_vendedor
	WHERE c.nombre LIKE CONCAT('%',#{nombreCliente},'%'); 
  	</select>
  
    <select id="findFacturaWeek" resultMap="FacturaCliente" parameterType="HashMap">
  	SELECT concat(cliente.nombre," ",cliente.apellido) AS ClienteNombre, 
  	concat(vendedor.nombre," ",vendedor.apellido) AS VendedorNombre,
 	producto.nombre, producto.precio, producto.precio_compra, detalle.cantidad,
 	detalle.monto, factura.fecha
  	FROM factura
  	JOIN cliente  ON factura.id_cliente  = cliente.id_cliente
  	JOIN vendedor ON factura.id_vendedor = vendedor.id_vendedor
  	JOIN detalle  ON factura.id_factura  = detalle.id_factura
  	JOIN producto ON detalle.id_producto = producto.id_producto
  	WHERE factura.fecha BETWEEN #{fechai} AND #{fechaf};
  </select>
  
  <insert id="insertFactura" parameterType="edu.utm.bd.domain.Factura">
  	INSERT INTO factura(id_cliente, id_vendedor, fecha, monto_total)
  	VALUES(#{idCliente}, #{idVendedor}, #{fecha}, #{montoTotal});
  </insert>
  
  <select id="lastIdFact" resultType="INTEGER">
  		SELECT MAX(id_factura) AS idFact FROM factura;
  </select>
  
</mapper>